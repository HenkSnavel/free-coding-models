# ğŸ“– Release workflow â€” publishes to npm, creates a GitHub Release, and notifies Discord.
#
# Triggered on every push to main. Compares the version in package.json
# against existing git tags â€” if no tag exists for that version, it:
#   1. Publishes to npm
#   2. Creates a GitHub Release with changelog extracted from CHANGELOG.md
#   3. Posts a rich embed to Discord with the release notes
#
# ğŸ“– Required secrets (Settings â†’ Secrets and variables â†’ Actions):
#   - NPM_TOKEN          : npm access token (npmjs.com â†’ Access Tokens â†’ Automation type)
#   - DISCORD_WEBHOOK_URL: Discord channel webhook URL (Channel settings â†’ Integrations â†’ Webhooks)

name: Release

on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ“– Read version from package.json and bail early if this version already has a tag.
      # ğŸ“– This prevents re-releasing when pushing non-version commits to main.
      - name: Check if release needed
        id: check
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "â„¹ï¸ Tag v$VERSION already exists â€” skipping release"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "ğŸš€ New version $VERSION detected â€” will publish"
          fi

      - uses: actions/setup-node@v4
        if: steps.check.outputs.skip == 'false'
        with:
          node-version: '20'
          registry-url: https://registry.npmjs.org

      - run: npm ci
        if: steps.check.outputs.skip == 'false'

      # ğŸ“– Publish to npm registry
      - name: Publish to npm
        if: steps.check.outputs.skip == 'false'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ğŸ“– Extract the changelog section for this version using Node.js.
      # ğŸ“– More reliable than awk: handles dots in version numbers, date suffixes
      # ğŸ“– (e.g. "## 0.1.41 â€” 2026-02-22"), and multi-line markdown content.
      # ğŸ“– Writes the extracted notes to release_notes.md for the next step.
      - name: Extract changelog
        if: steps.check.outputs.skip == 'false'
        id: changelog
        env:
          VERSION: ${{ steps.check.outputs.version }}
        run: |
          node - <<'EOF'
          const fs   = require('fs')
          const ver  = process.env.VERSION

          let notes = ''
          if (fs.existsSync('CHANGELOG.md')) {
            const text    = fs.readFileSync('CHANGELOG.md', 'utf8')
            const lines   = text.split('\n')
            let capturing = false
            const buf     = []

            for (const line of lines) {
              // ğŸ“– Start capturing when we hit the header for our version.
              // ğŸ“– The header may have a date suffix: "## 0.1.44" or "## 0.1.44 â€” 2026-02-22"
              if (!capturing && line.startsWith('## ') && line.includes(ver)) {
                capturing = true
                continue   // skip the header line itself
              }
              // ğŸ“– Stop when we hit the next version header (or end of file)
              if (capturing && line.startsWith('## ') && /^## \d+\./.test(line)) {
                break
              }
              if (capturing) buf.push(line)
            }

            // ğŸ“– Trim leading/trailing blank lines
            notes = buf.join('\n').trim()
          }

          if (notes) {
            console.log('ğŸ“ Changelog section found, length:', notes.length)
            fs.writeFileSync('release_notes.md', notes)
            // ğŸ“– Also expose a short version for the Discord embed (max 3800 chars)
            const short = notes.length > 3800 ? notes.slice(0, 3800) + '\n\nâ€¦_(see full release for more)_' : notes
            fs.writeFileSync('release_notes_short.md', short)
            process.stdout.write('has_notes=true\n')
            require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'has_notes=true\n')
          } else {
            console.log('âš ï¸ No changelog section found for version', ver)
            require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'has_notes=false\n')
          }
          EOF

      # ğŸ“– Create the GitHub Release with the extracted notes (or auto-generated if none found)
      - name: Create GitHub Release
        if: steps.check.outputs.skip == 'false'
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.check.outputs.version }}
          HAS_NOTES: ${{ steps.changelog.outputs.has_notes }}
        run: |
          git tag "v$VERSION"
          git push origin "v$VERSION"

          if [ "$HAS_NOTES" = "true" ]; then
            echo "ğŸ“ Creating release with CHANGELOG notes"
            gh release create "v$VERSION" \
              --title "v$VERSION" \
              --notes-file release_notes.md
          else
            echo "âš ï¸ No notes found â€” using auto-generated release notes"
            gh release create "v$VERSION" \
              --title "v$VERSION" \
              --generate-notes
          fi

          # ğŸ“– Get the release URL for the Discord embed
          RELEASE_URL=$(gh release view "v$VERSION" --json url -q .url)
          echo "release_url=$RELEASE_URL" >> "$GITHUB_OUTPUT"

      # ğŸ“– Post a rich embed to Discord with version, changelog excerpt, and a link to the release.
      # ğŸ“– Uses the DISCORD_WEBHOOK_URL secret â€” set it in Settings â†’ Secrets â†’ Actions.
      # ğŸ“– The embed color 0x76b900 is NVIDIA green (matches the project branding).
      # ğŸ“– If DISCORD_WEBHOOK_URL is not set, this step is silently skipped.
      - name: Notify Discord
        if: steps.check.outputs.skip == 'false' && secrets.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ steps.check.outputs.version }}
          RELEASE_URL: ${{ steps.release.outputs.release_url }}
          HAS_NOTES: ${{ steps.changelog.outputs.has_notes }}
        run: |
          node - <<'EOF'
          const https   = require('https')
          const fs      = require('fs')
          const url     = process.env.DISCORD_WEBHOOK_URL
          const version = process.env.VERSION
          const releaseUrl = process.env.RELEASE_URL ||
            `https://github.com/vava-nessa/free-coding-models/releases/tag/v${version}`

          // ğŸ“– Read the short changelog text (already truncated to 3800 chars)
          let changelogText = ''
          if (fs.existsSync('release_notes_short.md')) {
            changelogText = fs.readFileSync('release_notes_short.md', 'utf8').trim()
          }

          // ğŸ“– Build the Discord embed payload
          const embed = {
            title: `âš¡ free-coding-models v${version} released!`,
            url: releaseUrl,
            color: 0x76b900,   // ğŸ“– NVIDIA green
            description: changelogText || '_No changelog details available._',
            fields: [
              {
                name: 'ğŸ“¦ Install / Update',
                value: `\`\`\`bash\nnpm i -g free-coding-models@${version}\n\`\`\``,
                inline: false,
              },
            ],
            footer: {
              text: 'free-coding-models â€¢ npm publish',
            },
            timestamp: new Date().toISOString(),
          }

          const body = JSON.stringify({ embeds: [embed] })

          const urlObj = new URL(url)
          const req = https.request(
            {
              hostname: urlObj.hostname,
              path: urlObj.pathname + urlObj.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(body),
              },
            },
            (res) => {
              console.log('Discord response status:', res.statusCode)
              if (res.statusCode >= 200 && res.statusCode < 300) {
                console.log('âœ… Discord notification sent')
              } else {
                console.error('âŒ Discord notification failed:', res.statusCode)
                process.exit(1)
              }
            }
          )
          req.on('error', (e) => { console.error('âŒ Request error:', e); process.exit(1) })
          req.write(body)
          req.end()
          EOF
